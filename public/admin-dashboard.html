<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CartWhisper AI - åç«¯ç›‘æ§ç®¡ç†</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
    }

    .header {
      background: white;
      border-radius: 12px;
      padding: 30px;
      margin-bottom: 20px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    .header h1 {
      color: #333;
      font-size: 32px;
      margin-bottom: 10px;
    }

    .header p {
      color: #666;
      font-size: 16px;
    }

    .filters {
      background: white;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    .filter-row {
      display: flex;
      gap: 15px;
      flex-wrap: wrap;
      align-items: center;
    }

    .filter-group {
      display: flex;
      flex-direction: column;
      gap: 5px;
    }

    .filter-group label {
      font-size: 14px;
      color: #666;
      font-weight: 500;
    }

    .filter-group select,
    .filter-group input {
      padding: 10px 15px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 14px;
      min-width: 200px;
      transition: border-color 0.3s;
    }

    .filter-group select:focus,
    .filter-group input:focus {
      outline: none;
      border-color: #667eea;
    }

    .btn {
      padding: 10px 20px;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      margin-top: auto;
    }

    .btn-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 20px;
    }

    .stat-card {
      background: white;
      border-radius: 12px;
      padding: 25px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      transition: transform 0.3s;
    }

    .stat-card:hover {
      transform: translateY(-5px);
    }

    .stat-card h3 {
      color: #666;
      font-size: 14px;
      font-weight: 500;
      margin-bottom: 10px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .stat-card .value {
      color: #333;
      font-size: 36px;
      font-weight: 700;
      margin-bottom: 5px;
    }

    .stat-card .subtitle {
      color: #999;
      font-size: 13px;
    }

    .stat-card.success .value {
      color: #10b981;
    }

    .stat-card.danger .value {
      color: #ef4444;
    }

    .stat-card.warning .value {
      color: #f59e0b;
    }

    .stat-card.info .value {
      color: #3b82f6;
    }

    .tabs {
      background: white;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    .tab-buttons {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      border-bottom: 2px solid #e0e0e0;
      padding-bottom: 10px;
    }

    .tab-btn {
      padding: 10px 20px;
      border: none;
      background: transparent;
      color: #666;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      border-bottom: 3px solid transparent;
      transition: all 0.3s;
    }

    .tab-btn.active {
      color: #667eea;
      border-bottom-color: #667eea;
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    .table-container {
      overflow-x: auto;
    }

    table {
      width: 100%;
      border-collapse: collapse;
    }

    th {
      background: #f9fafb;
      padding: 15px;
      text-align: left;
      font-weight: 600;
      color: #666;
      font-size: 13px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      border-bottom: 2px solid #e0e0e0;
    }

    td {
      padding: 15px;
      border-bottom: 1px solid #f0f0f0;
      color: #333;
      font-size: 14px;
    }

    tr:hover {
      background: #f9fafb;
    }

    .badge {
      display: inline-block;
      padding: 5px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
    }

    .badge-success {
      background: #d1fae5;
      color: #065f46;
    }

    .badge-danger {
      background: #fee2e2;
      color: #991b1b;
    }

    .badge-warning {
      background: #fef3c7;
      color: #92400e;
    }

    .badge-info {
      background: #dbeafe;
      color: #1e40af;
    }

    .loading {
      text-align: center;
      padding: 40px;
      color: #666;
    }

    .spinner {
      border: 3px solid #f3f3f3;
      border-top: 3px solid #667eea;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 0 auto 15px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .error {
      background: #fee2e2;
      color: #991b1b;
      padding: 15px;
      border-radius: 8px;
      margin: 20px 0;
    }

    .empty {
      text-align: center;
      padding: 60px 20px;
      color: #999;
    }

    .empty-icon {
      font-size: 48px;
      margin-bottom: 15px;
    }

    .chart-container {
      margin: 20px 0;
      padding: 20px;
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    }

    .chart-container h3 {
      color: #333;
      font-size: 18px;
      margin-bottom: 15px;
      font-weight: 600;
    }

    .charts-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
      gap: 20px;
      margin-bottom: 20px;
    }

    .shop-list {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 15px;
      margin-top: 20px;
    }

    .shop-card {
      background: #f9fafb;
      padding: 20px;
      border-radius: 8px;
      border-left: 4px solid #667eea;
    }

    .shop-card h4 {
      color: #333;
      margin-bottom: 10px;
      font-size: 16px;
    }

    .shop-card .info {
      display: flex;
      justify-content: space-between;
      margin: 5px 0;
      font-size: 13px;
      color: #666;
    }

    .log-detail {
      background: #f9fafb;
      padding: 15px;
      border-radius: 8px;
      margin-top: 10px;
      font-family: 'Courier New', monospace;
      font-size: 12px;
      max-height: 200px;
      overflow-y: auto;
    }

    .log-detail pre {
      white-space: pre-wrap;
      word-wrap: break-word;
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Header -->
    <div class="header">
      <h1>ğŸš€ CartWhisper AI åç«¯ç›‘æ§</h1>
      <p>å®æ—¶ç›‘æ§åŒæ­¥æ“ä½œã€Tokenæ¶ˆè€—å’Œç³»ç»Ÿæ€§èƒ½</p>
    </div>

    <!-- Filters -->
    <div class="filters">
      <div class="filter-row">
        <div class="filter-group">
          <label>å•†åº—åŸŸå</label>
          <select id="shopFilter">
            <option value="">æ‰€æœ‰å•†åº—</option>
          </select>
        </div>
        <div class="filter-group">
          <label>æ—¶é—´èŒƒå›´</label>
          <select id="daysFilter">
            <option value="1">æœ€è¿‘1å¤©</option>
            <option value="3">æœ€è¿‘3å¤©</option>
            <option value="7" selected>æœ€è¿‘7å¤©</option>
            <option value="30">æœ€è¿‘30å¤©</option>
          </select>
        </div>
        <div class="filter-group">
          <label>çŠ¶æ€</label>
          <select id="statusFilter">
            <option value="">å…¨éƒ¨</option>
            <option value="success">æˆåŠŸ</option>
            <option value="failed">å¤±è´¥</option>
            <option value="started">è¿›è¡Œä¸­</option>
          </select>
        </div>
        <button class="btn btn-primary" onclick="loadData()">ğŸ”„ åˆ·æ–°æ•°æ®</button>
      </div>
    </div>

    <!-- Stats Grid -->
    <div class="stats-grid" id="statsGrid">
      <div class="stat-card">
        <h3>æ€»åŒæ­¥æ¬¡æ•°</h3>
        <div class="value">-</div>
        <div class="subtitle">åŠ è½½ä¸­...</div>
      </div>
      <div class="stat-card success">
        <h3>æˆåŠŸç‡</h3>
        <div class="value">-</div>
        <div class="subtitle">åŠ è½½ä¸­...</div>
      </div>
      <div class="stat-card warning">
        <h3>Tokenæ¶ˆè€—</h3>
        <div class="value">-</div>
        <div class="subtitle">åŠ è½½ä¸­...</div>
      </div>
      <div class="stat-card info">
        <h3>æ€»æˆæœ¬</h3>
        <div class="value">-</div>
        <div class="subtitle">åŠ è½½ä¸­...</div>
      </div>
    </div>

    <!-- Tabs -->
    <div class="tabs">
      <div class="tab-buttons">
        <button class="tab-btn active" onclick="switchTab('charts')">ğŸ“ˆ å›¾è¡¨åˆ†æ</button>
        <button class="tab-btn" onclick="switchTab('logs')">ğŸ“‹ åŒæ­¥æ—¥å¿—</button>
        <button class="tab-btn" onclick="switchTab('daily')">ğŸ“Š æ¯æ—¥ç»Ÿè®¡</button>
        <button class="tab-btn" onclick="switchTab('shops')">ğŸª å•†åº—åˆ—è¡¨</button>
      </div>

      <!-- Charts Tab -->
      <div id="chartsTab" class="tab-content active">
        <div class="charts-grid">
          <div class="chart-container">
            <h3>ğŸ“Š æ¯æ—¥Tokenæ¶ˆè€—è¶‹åŠ¿</h3>
            <canvas id="tokenChart"></canvas>
          </div>
          <div class="chart-container">
            <h3>ğŸ“¦ æ¯æ—¥åŒæ­¥å•†å“æ•°é‡</h3>
            <canvas id="productsChart"></canvas>
          </div>
          <div class="chart-container">
            <h3>âœ… åŒæ­¥æˆåŠŸç‡</h3>
            <canvas id="successChart"></canvas>
          </div>
          <div class="chart-container">
            <h3>â±ï¸ å¹³å‡è€—æ—¶è¶‹åŠ¿</h3>
            <canvas id="durationChart"></canvas>
          </div>
        </div>
      </div>

      <!-- Logs Tab -->
      <div id="logsTab" class="tab-content">
        <div id="logsContent">
          <div class="loading">
            <div class="spinner"></div>
            <p>åŠ è½½åŒæ­¥æ—¥å¿—...</p>
          </div>
        </div>
      </div>

      <!-- Daily Stats Tab -->
      <div id="dailyTab" class="tab-content">
        <div id="dailyContent">
          <div class="loading">
            <div class="spinner"></div>
            <p>åŠ è½½æ¯æ—¥ç»Ÿè®¡...</p>
          </div>
        </div>
      </div>

      <!-- Shops Tab -->
      <div id="shopsTab" class="tab-content">
        <div id="shopsContent">
          <div class="loading">
            <div class="spinner"></div>
            <p>åŠ è½½å•†åº—åˆ—è¡¨...</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const API_BASE = window.location.origin;
    let currentTab = 'charts';
    let statsData = null;
    let logsData = null;
    let shopsData = null;
    let charts = {};

    // åˆå§‹åŒ–
    async function init() {
      await loadShops();
      await loadData();
      // è‡ªåŠ¨åˆ·æ–°ï¼ˆæ¯30ç§’ï¼‰
      setInterval(loadData, 30000);
    }

    // åŠ è½½å•†åº—åˆ—è¡¨
    async function loadShops() {
      try {
        const response = await fetch(`${API_BASE}/api/monitoring/shops`);
        const data = await response.json();

        if (data.success) {
          shopsData = data.shops;
          const select = document.getElementById('shopFilter');
          select.innerHTML = '<option value="">æ‰€æœ‰å•†åº—</option>';
          data.shops.forEach(shop => {
            const option = document.createElement('option');
            option.value = shop.domain;
            option.textContent = `${shop.domain} (${shop.plan})`;
            select.appendChild(option);
          });
        }
      } catch (error) {
        console.error('Failed to load shops:', error);
      }
    }

    // åŠ è½½æ‰€æœ‰æ•°æ®
    async function loadData() {
      const days = document.getElementById('daysFilter').value;
      const shopDomain = document.getElementById('shopFilter').value;
      const status = document.getElementById('statusFilter').value;

      await Promise.all([
        loadStats(days, shopDomain),
        loadLogs(days, shopDomain, status),
        loadShopsList()
      ]);

      // æ¸²æŸ“å›¾è¡¨
      if (currentTab === 'charts') {
        renderCharts();
      }
    }

    // åŠ è½½ç»Ÿè®¡æ•°æ®
    async function loadStats(days, shopDomain) {
      try {
        let url = `${API_BASE}/api/monitoring/stats?days=${days}`;
        if (shopDomain) url += `&shopDomain=${shopDomain}`;

        const response = await fetch(url);
        const data = await response.json();

        if (data.success) {
          statsData = data;
          renderStats(data);
        }
      } catch (error) {
        console.error('Failed to load stats:', error);
        document.getElementById('statsGrid').innerHTML = `
          <div class="error">åŠ è½½ç»Ÿè®¡æ•°æ®å¤±è´¥: ${error.message}</div>
        `;
      }
    }

    // æ¸²æŸ“ç»Ÿè®¡å¡ç‰‡
    function renderStats(data) {
      const { summary } = data;
      const successRate = summary.totalSyncs > 0
        ? ((summary.successfulSyncs / summary.totalSyncs) * 100).toFixed(1)
        : 0;

      document.getElementById('statsGrid').innerHTML = `
        <div class="stat-card">
          <h3>æ€»åŒæ­¥æ¬¡æ•°</h3>
          <div class="value">${summary.totalSyncs}</div>
          <div class="subtitle">æˆåŠŸ ${summary.successfulSyncs} / å¤±è´¥ ${summary.failedSyncs}</div>
        </div>
        <div class="stat-card success">
          <h3>æˆåŠŸç‡</h3>
          <div class="value">${successRate}%</div>
          <div class="subtitle">å¹³å‡è€—æ—¶ ${(summary.avgDuration / 1000).toFixed(2)}s</div>
        </div>
        <div class="stat-card warning">
          <h3>Tokenæ¶ˆè€—</h3>
          <div class="value">${summary.totalTokens.toLocaleString()}</div>
          <div class="subtitle">ç”Ÿæˆ ${summary.totalRecommendations} ä¸ªæ¨è</div>
        </div>
        <div class="stat-card info">
          <h3>æ€»æˆæœ¬</h3>
          <div class="value">$${summary.totalCost.toFixed(2)}</div>
          <div class="subtitle">DeepSeek API</div>
        </div>
      `;
    }

    // åŠ è½½åŒæ­¥æ—¥å¿—
    async function loadLogs(days, shopDomain, status) {
      try {
        let url = `${API_BASE}/api/monitoring/all-sync-logs?days=${days}&limit=50`;
        if (shopDomain) url += `&shopDomain=${shopDomain}`;
        if (status) url += `&status=${status}`;

        const response = await fetch(url);
        const data = await response.json();

        if (data.success) {
          logsData = data.logs;
          renderLogs(data.logs);
        }
      } catch (error) {
        console.error('Failed to load logs:', error);
        document.getElementById('logsContent').innerHTML = `
          <div class="error">åŠ è½½æ—¥å¿—å¤±è´¥: ${error.message}</div>
        `;
      }
    }

    // æ¸²æŸ“æ—¥å¿—è¡¨æ ¼
    function renderLogs(logs) {
      if (logs.length === 0) {
        document.getElementById('logsContent').innerHTML = `
          <div class="empty">
            <div class="empty-icon">ğŸ“­</div>
            <p>æš‚æ— åŒæ­¥æ—¥å¿—</p>
          </div>
        `;
        return;
      }

      const html = `
        <div class="table-container">
          <table>
            <thead>
              <tr>
                <th>å•†åº—</th>
                <th>æ¨¡å¼</th>
                <th>çŠ¶æ€</th>
                <th>å¼€å§‹æ—¶é—´</th>
                <th>è€—æ—¶</th>
                <th>å•†å“æ•°</th>
                <th>æ¨èæ•°</th>
                <th>Token</th>
                <th>æˆæœ¬</th>
                <th>æ“ä½œ</th>
              </tr>
            </thead>
            <tbody>
              ${logs.map(log => `
                <tr>
                  <td>
                    <strong>${log.shopDomain}</strong><br>
                    <small style="color: #999;">${log.plan}</small>
                  </td>
                  <td><span class="badge badge-info">${log.mode}</span></td>
                  <td>${getStatusBadge(log.status)}</td>
                  <td>${formatDate(log.startedAt)}</td>
                  <td>${log.durationMs ? (log.durationMs / 1000).toFixed(2) + 's' : '-'}</td>
                  <td>${log.productsScanned} / ${log.productsSynced}</td>
                  <td>${log.recommendationsGenerated}</td>
                  <td>${log.tokensUsed.toLocaleString()}</td>
                  <td>$${log.estimatedCost.toFixed(4)}</td>
                  <td>
                    ${log.errorMessage ? `<button class="btn" onclick="showError('${escapeHtml(log.errorMessage)}', '${escapeHtml(log.errorStack || '')}')">æŸ¥çœ‹é”™è¯¯</button>` : '-'}
                  </td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        </div>
      `;

      document.getElementById('logsContent').innerHTML = html;
    }

    // æ¸²æŸ“æ¯æ—¥ç»Ÿè®¡
    function renderDaily() {
      if (!statsData || !statsData.daily) {
        document.getElementById('dailyContent').innerHTML = `
          <div class="loading">
            <div class="spinner"></div>
            <p>åŠ è½½æ¯æ—¥ç»Ÿè®¡...</p>
          </div>
        `;
        return;
      }

      const { daily } = statsData;

      if (daily.length === 0) {
        document.getElementById('dailyContent').innerHTML = `
          <div class="empty">
            <div class="empty-icon">ğŸ“Š</div>
            <p>æš‚æ— ç»Ÿè®¡æ•°æ®</p>
          </div>
        `;
        return;
      }

      const html = `
        <div class="table-container">
          <table>
            <thead>
              <tr>
                <th>æ—¥æœŸ</th>
                <th>åŒæ­¥æ¬¡æ•°</th>
                <th>Tokenæ¶ˆè€—</th>
                <th>æˆæœ¬</th>
                <th>å¹³å‡è€—æ—¶</th>
              </tr>
            </thead>
            <tbody>
              ${daily.map(day => `
                <tr>
                  <td><strong>${formatDate(day.date)}</strong></td>
                  <td>${day.syncCount}</td>
                  <td>${day.totalTokens.toLocaleString()}</td>
                  <td>$${day.totalCost.toFixed(4)}</td>
                  <td>${(day.avgDuration / 1000).toFixed(2)}s</td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        </div>
      `;

      document.getElementById('dailyContent').innerHTML = html;
    }

    // åŠ è½½å•†åº—åˆ—è¡¨
    async function loadShopsList() {
      if (!shopsData) return;

      renderShopsList(shopsData);
    }

    // æ¸²æŸ“å•†åº—åˆ—è¡¨
    function renderShopsList(shops) {
      if (shops.length === 0) {
        document.getElementById('shopsContent').innerHTML = `
          <div class="empty">
            <div class="empty-icon">ğŸª</div>
            <p>æš‚æ— å•†åº—</p>
          </div>
        `;
        return;
      }

      const html = `
        <div class="shop-list">
          ${shops.map(shop => `
            <div class="shop-card">
              <h4>${shop.domain}</h4>
              <div class="info">
                <span>è®¡åˆ’:</span>
                <span><strong>${shop.plan.toUpperCase()}</strong></span>
              </div>
              <div class="info">
                <span>å•†å“æ•°:</span>
                <span>${shop.productCount || 0}</span>
              </div>
              <div class="info">
                <span>é¦–æ¬¡åŒæ­¥:</span>
                <span>${shop.initialSyncDone ? 'âœ… å·²å®Œæˆ' : 'â³ æœªå®Œæˆ'}</span>
              </div>
              <div class="info">
                <span>ä¸Šæ¬¡åˆ·æ–°:</span>
                <span>${shop.lastRefreshAt ? formatDate(shop.lastRefreshAt) : '-'}</span>
              </div>
              <div class="info">
                <span>åˆ›å»ºæ—¶é—´:</span>
                <span>${formatDate(shop.createdAt)}</span>
              </div>
            </div>
          `).join('')}
        </div>
      `;

      document.getElementById('shopsContent').innerHTML = html;
    }

    // æ¸²æŸ“å›¾è¡¨
    function renderCharts() {
      if (!statsData || !statsData.daily || statsData.daily.length === 0) {
        return;
      }

      const daily = statsData.daily.slice().reverse(); // æŒ‰æ—¶é—´æ­£åºæ’åˆ—
      const labels = daily.map(d => formatDate(d.date).split(' ')[0]);

      // é”€æ¯æ—§å›¾è¡¨
      Object.values(charts).forEach(chart => {
        if (chart) chart.destroy();
      });

      // Tokenæ¶ˆè€—è¶‹åŠ¿å›¾
      const tokenCtx = document.getElementById('tokenChart').getContext('2d');
      charts.token = new Chart(tokenCtx, {
        type: 'line',
        data: {
          labels: labels,
          datasets: [{
            label: 'Tokenæ¶ˆè€—',
            data: daily.map(d => d.totalTokens),
            borderColor: '#f59e0b',
            backgroundColor: 'rgba(245, 158, 11, 0.1)',
            tension: 0.4,
            fill: true
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: true,
          plugins: {
            legend: { display: false },
            tooltip: {
              callbacks: {
                label: (context) => `Token: ${context.parsed.y.toLocaleString()}`
              }
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                callback: (value) => value.toLocaleString()
              }
            }
          }
        }
      });

      // å•†å“æ•°é‡è¶‹åŠ¿å›¾
      const productsCtx = document.getElementById('productsChart').getContext('2d');
      charts.products = new Chart(productsCtx, {
        type: 'bar',
        data: {
      abels: labels,
          datasets: [{
            label: 'åŒæ­¥æ¬¡æ•°',
            data: daily.map(d => d.syncCount),
            backgroundColor: '#3b82f6',
            borderRadius: 6
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: true,
          plugins: {
            legend: { display: false }
          },
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                stepSize: 1
              }
            }
          }
        }
      });

      // æˆåŠŸç‡å›¾è¡¨ï¼ˆåŸºäºæ—¥å¿—æ•°æ®ï¼‰
      const successData = calculateSuccessRate(daily);
      const successCtx = document.getElementById('successChart').getContext('2d');
      charts.success = new Chart(successCtx, {
        type: 'line',
        data: {
          labels: labels,
          datasets: [{
            label: 'æˆåŠŸç‡ (%)',
            data: successData,
            borderColor: '#10b981',
            backgroundColor: 'rgba(16, 185, 129, 0.1)',
            tension: 0.4,
            fill: true
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: true,
          plugins: {
            legend: { display: false },
            tooltip: {
              callbacks: {
                label: (context) => `æˆåŠŸç‡: ${context.parsed.y.toFixed(1)}%`
              }
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              max: 100,
              ticks: {
                callback: (value) => value + '%'
              }
            }
          }
        }
      });

      // è€—æ—¶è¶‹åŠ¿å›¾
      const durationCtx = document.getElementById('durationChart').getContext('2d');
      charts.duration = new Chart(durationCtx, {
        type: 'line',
        data: {
          labels: labels,
          datasets: [{
            label: 'å¹³å‡è€—æ—¶ (ç§’)',
            data: daily.map(d => (d.avgDuration / 1000).toFixed(2)),
            borderColor: '#8b5cf6',
            backgroundColor: 'rgba(139, 92, 246, 0.1)',
            tension: 0.4,
            fill: true
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: true,
          plugins: {
            legend: { display: false },
            tooltip: {
              callbacks: {
                label: (context) => `è€—æ—¶: ${context.parsed.y}ç§’`
              }
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                callback: (value) => value + 's'
              }
            }
          }
        }
      });
    }

    // è®¡ç®—æˆåŠŸç‡ï¼ˆå‡è®¾æ‰€æœ‰åŒæ­¥éƒ½æˆåŠŸï¼Œå®é™…åº”è¯¥ä»æ—¥å¿—ä¸­ç»Ÿè®¡ï¼‰
    function calculateSuccessRate(daily) {
      // ç®€åŒ–ç‰ˆæœ¬ï¼šå‡è®¾æˆåŠŸç‡ä¸º100%
      // å®é™…åº”è¯¥ä»logsDataä¸­æŒ‰æ—¥æœŸç»Ÿè®¡æˆåŠŸ/å¤±è´¥æ•°é‡
      return daily.map(d => {
        if (!logsData) return 100;

        const dayLogs = logsData.filter(log => {
          const logDate = new Date(log.startedAt).toISOString().split('T')[0];
          const targetDate = new Date(d.date).toISOString().split('T')[0];
          return logDate === targetDate;
        });

        if (dayLogs.length === 0) return 100;

        const successCount = dayLogs.filter(log => log.status === 'success').length;
        return (successCount / dayLogs.length * 100).toFixed(1);
      });
    }

    // åˆ‡æ¢æ ‡ç­¾
    function switchTab(tab) {
      currentTab = tab;

      // æ›´æ–°æŒ‰é’®çŠ¶æ€
      document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
      event.target.classList.add('active');

      // æ›´æ–°å†…å®¹æ˜¾ç¤º
      document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
      document.getElementById(`${tab}Tab`).classList.add('active');

      // æ¸²æŸ“å¯¹åº”å†…å®¹
      if (tab === 'charts') {
        renderCharts();
      } else if (tab === 'daily') {
        renderDaily();
      } else if (tab === 'shops') {
        loadShopsList();
      }
    }

    // æ˜¾ç¤ºé”™è¯¯è¯¦æƒ…
    function showError(message, stack) {
      alert(`é”™è¯¯ä¿¡æ¯:\n${message}\n\nå †æ ˆ:\n${stack}`);
    }

    // å·¥å…·å‡½æ•°
    function getStatusBadge(status) {
      const badges = {
        success: '<span class="badge badge-success">æˆåŠŸ</span>',
        failed: '<span class="badge badge-danger">å¤±è´¥</span>',
        started: '<span class="badge badge-warning">è¿›è¡Œä¸­</span>'
      };
      return badges[status] || status;
    }

    function formatDate(dateStr) {
      const date = new Date(dateStr);
      return date.toLocaleString('zh-CN', {
        year: 'numeric',
        month: '2-digit',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit'
      });
    }

    function escapeHtml(text) {
      if (!text) return '';
      return text.replace(/'/g, "\\'").replace(/"/g, '\\"').replace(/\n/g, '\\n');
    }

    // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
    window.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
