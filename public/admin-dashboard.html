<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CartWhisper AI - åç«¯ç›‘æ§ç®¡ç†</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
    }

    .header {
      background: white;
      border-radius: 12px;
      padding: 30px;
      margin-bottom: 20px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    .header h1 {
      color: #333;
      font-size: 32px;
      margin-bottom: 10px;
    }

    .header p {
      color: #666;
      font-size: 16px;
    }

    .filters {
      background: white;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    .filter-row {
      display: flex;
      gap: 15px;
      flex-wrap: wrap;
      align-items: center;
    }

    .filter-group {
      display: flex;
      flex-direction: column;
      gap: 5px;
    }

    .filter-group label {
      font-size: 14px;
      color: #666;
      font-weight: 500;
    }

    .filter-group select,
    .filter-group input {
      padding: 10px 15px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 14px;
      min-width: 200px;
      transition: border-color 0.3s;
    }

    .filter-group select:focus,
    .filter-group input:focus {
      outline: none;
      border-color: #667eea;
    }

    .btn {
      padding: 10px 20px;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      margin-top: auto;
    }

    .btn-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 20px;
    }

    .stat-card {
      background: white;
      border-radius: 12px;
      padding: 25px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      transition: transform 0.3s;
    }

    .stat-card:hover {
      transform: translateY(-5px);
    }

    .stat-card h3 {
      color: #666;
      font-size: 14px;
      font-weight: 500;
      margin-bottom: 10px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .stat-card .value {
      color: #333;
      font-size: 36px;
      font-weight: 700;
      margin-bottom: 5px;
    }

    .stat-card .subtitle {
      color: #999;
      font-size: 13px;
    }

    .stat-card.success .value {
      color: #10b981;
    }

    .stat-card.danger .value {
      color: #ef4444;
    }

    .stat-card.warning .value {
      color: #f59e0b;
    }

    .stat-card.info .value {
      color: #3b82f6;
    }

    .tabs {
      background: white;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    .tab-buttons {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      border-bottom: 2px solid #e0e0e0;
      padding-bottom: 10px;
    }

    .tab-btn {
      padding: 10px 20px;
      border: none;
      background: transparent;
      color: #666;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      border-bottom: 3px solid transparent;
      transition: all 0.3s;
    }

    .tab-btn.active {
      color: #667eea;
      border-bottom-color: #667eea;
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    .table-container {
      overflow-x: auto;
    }

    table {
      width: 100%;
      border-collapse: collapse;
    }

    th {
      background: #f9fafb;
      padding: 15px;
      text-align: left;
      font-weight: 600;
      color: #666;
      font-size: 13px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      border-bottom: 2px solid #e0e0e0;
    }

    td {
      padding: 15px;
      border-bottom: 1px solid #f0f0f0;
      color: #333;
      font-size: 14px;
    }

    tr:hover {
      background: #f9fafb;
    }

    .badge {
      display: inline-block;
      padding: 5px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
      transition: all 0.2s ease;
    }

    .badge:hover {
      transform: translateY(-1px);
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.15);
    }

    .badge-success {
      background: #d1fae5;
      color: #065f46;
    }

    .badge-danger {
      background: #fee2e2;
      color: #991b1b;
    }

    .badge-warning {
      background: #fef3c7;
      color: #92400e;
    }

    .badge-info {
      background: #dbeafe;
      color: #1e40af;
    }

    .loading {
      text-align: center;
      padding: 40px;
      color: #666;
    }

    .spinner {
      border: 3px solid #f3f3f3;
      border-top: 3px solid #667eea;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 0 auto 15px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .error {
      background: #fee2e2;
      color: #991b1b;
      padding: 15px;
      border-radius: 8px;
      margin: 20px 0;
    }

    .empty {
      text-align: center;
      padding: 60px 20px;
      color: #999;
    }

    .empty-icon {
      font-size: 48px;
      margin-bottom: 15px;
    }

    .chart-container {
      margin: 20px 0;
      padding: 20px;
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    }

    .chart-container h3 {
      color: #333;
      font-size: 18px;
      margin-bottom: 15px;
      font-weight: 600;
    }

    .charts-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
      gap: 20px;
      margin-bottom: 20px;
    }

    .shop-list {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 15px;
      margin-top: 20px;
    }

    .shop-card {
      background: #f9fafb;
      padding: 20px;
      border-radius: 8px;
      border-left: 4px solid #667eea;
    }

    .shop-card h4 {
      color: #333;
      margin-bottom: 10px;
      font-size: 16px;
    }

    .shop-card .info {
      display: flex;
      justify-content: space-between;
      margin: 5px 0;
      font-size: 13px;
      color: #666;
    }

    .log-detail {
      background: #f9fafb;
      padding: 15px;
      border-radius: 8px;
      margin-top: 10px;
      font-family: 'Courier New', monospace;
      font-size: 12px;
      max-height: 200px;
      overflow-y: auto;
    }

    .log-detail pre {
      white-space: pre-wrap;
      word-wrap: break-word;
    }

    .recommendations-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding: 15px;
      background: #f9fafb;
      border-radius: 8px;
    }

    .recommendations-header .info {
      display: flex;
      gap: 30px;
    }

    .recommendations-header .info-item {
      display: flex;
      flex-direction: column;
    }

    .recommendations-header .info-item label {
      font-size: 12px;
      color: #666;
      text-transform: uppercase;
      margin-bottom: 5px;
    }

    .recommendations-header .info-item .value {
      font-size: 24px;
      font-weight: 700;
      color: #333;
    }

    .btn-danger {
      background: #ef4444;
      color: white;
    }

    .btn-danger:hover {
      background: #dc2626;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(239, 68, 68, 0.4);
    }

    .recommendation-card {
      background: white;
      border: 1px solid #e0e0e0;
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 15px;
      transition: all 0.3s;
    }

    .recommendation-card:hover {
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      transform: translateY(-2px);
    }

    .recommendation-card-header {
      display: flex;
      gap: 15px;
      align-items: center;
      margin-bottom: 15px;
      padding-bottom: 15px;
      border-bottom: 2px solid #f0f0f0;
    }

    .product-image {
      width: 80px;
      height: 80px;
      object-fit: cover;
      border-radius: 8px;
      border: 2px solid #e0e0e0;
    }

    .product-info {
      flex: 1;
    }

    .product-info h4 {
      color: #333;
      font-size: 16px;
      margin-bottom: 5px;
      font-weight: 600;
    }

    .product-info .product-id {
      color: #999;
      font-size: 12px;
      font-family: 'Courier New', monospace;
    }

    .recommendations-list {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 15px;
    }

    .recommendation-item {
      background: #f9fafb;
      border-radius: 8px;
      padding: 15px;
      border-left: 3px solid #667eea;
    }

    .recommendation-item img {
      width: 100%;
      height: 120px;
      object-fit: cover;
      border-radius: 6px;
      margin-bottom: 10px;
    }

    .recommendation-item h5 {
      color: #333;
      font-size: 14px;
      margin-bottom: 5px;
      font-weight: 600;
      line-height: 1.3;
    }

    .recommendation-item .reason {
      color: #666;
      font-size: 12px;
      line-height: 1.4;
      margin-top: 8px;
      padding-top: 8px;
      border-top: 1px solid #e0e0e0;
    }

    .api-key-input {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      align-items: center;
    }

    .api-key-input input {
      flex: 1;
      padding: 10px 15px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 14px;
      font-family: 'Courier New', monospace;
    }

    .api-key-input input:focus {
      outline: none;
      border-color: #667eea;
    }

    .whitelist-table td {
      vertical-align: middle;
    }

    .toggle-switch {
      position: relative;
      display: inline-block;
      width: 50px;
      height: 24px;
    }

    .toggle-switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }

    .toggle-slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: #ccc;
      transition: .4s;
      border-radius: 24px;
    }

    .toggle-slider:before {
      position: absolute;
      content: "";
      height: 18px;
      width: 18px;
      left: 3px;
      bottom: 3px;
      background-color: white;
      transition: .4s;
      border-radius: 50%;
    }

    .toggle-switch input:checked + .toggle-slider {
      background-color: #10b981;
    }

    .toggle-switch input:checked + .toggle-slider:before {
      transform: translateX(26px);
    }

    .badge-dev {
      background: #fee2e2;
      color: #991b1b;
    }

    .badge-regular {
      background: #dbeafe;
      color: #1e40af;
    }

    .badge-whitelisted {
      background: #d1fae5;
      color: #065f46;
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Header -->
    <div class="header">
      <h1>ğŸš€ CartWhisper AI åç«¯ç›‘æ§</h1>
      <p>å®æ—¶ç›‘æ§åŒæ­¥æ“ä½œã€Tokenæ¶ˆè€—å’Œç³»ç»Ÿæ€§èƒ½</p>
    </div>

    <!-- Filters -->
    <div class="filters">
      <div class="filter-row">
        <div class="filter-group">
          <label>å•†åº—åŸŸå</label>
          <select id="shopFilter">
            <option value="">æ‰€æœ‰å•†åº—</option>
          </select>
        </div>
        <div class="filter-group">
          <label>æ—¶é—´èŒƒå›´</label>
          <select id="daysFilter">
            <option value="1">æœ€è¿‘1å¤©</option>
            <option value="3">æœ€è¿‘3å¤©</option>
            <option value="7" selected>æœ€è¿‘7å¤©</option>
            <option value="30">æœ€è¿‘30å¤©</option>
          </select>
        </div>
        <div class="filter-group">
          <label>çŠ¶æ€</label>
          <select id="statusFilter">
            <option value="">å…¨éƒ¨</option>
            <option value="success">æˆåŠŸ</option>
            <option value="failed">å¤±è´¥</option>
            <option value="started">è¿›è¡Œä¸­</option>
          </select>
        </div>
        <button class="btn btn-primary" onclick="loadData()">ğŸ”„ åˆ·æ–°æ•°æ®</button>
      </div>
    </div>

    <!-- Stats Grid -->
    <div class="stats-grid" id="statsGrid">
      <div class="stat-card">
        <h3>æ€»åŒæ­¥æ¬¡æ•°</h3>
        <div class="value">-</div>
        <div class="subtitle">åŠ è½½ä¸­...</div>
      </div>
      <div class="stat-card success">
        <h3>æˆåŠŸç‡</h3>
        <div class="value">-</div>
        <div class="subtitle">åŠ è½½ä¸­...</div>
      </div>
      <div class="stat-card warning">
        <h3>Tokenæ¶ˆè€—</h3>
        <div class="value">-</div>
        <div class="subtitle">åŠ è½½ä¸­...</div>
      </div>
      <div class="stat-card info">
        <h3>æ€»æˆæœ¬</h3>
        <div class="value">-</div>
        <div class="subtitle">åŠ è½½ä¸­...</div>
      </div>
      <div class="stat-card warning">
        <h3>Tokené…é¢ä½¿ç”¨</h3>
        <div class="value">-</div>
        <div class="subtitle">åŠ è½½ä¸­...</div>
      </div>
    </div>

    <!-- Tabs -->
    <div class="tabs">
      <div class="tab-buttons">
        <button class="tab-btn active" onclick="switchTab('charts')">ğŸ“ˆ å›¾è¡¨åˆ†æ</button>
        <button class="tab-btn" onclick="switchTab('logs')">ğŸ“‹ åŒæ­¥æ—¥å¿—</button>
        <button class="tab-btn" onclick="switchTab('daily')">ğŸ“Š æ¯æ—¥ç»Ÿè®¡</button>
        <button class="tab-btn" onclick="switchTab('shops')">ğŸª å•†åº—åˆ—è¡¨</button>
        <button class="tab-btn" onclick="switchTab('whitelist')">ğŸ” å¼€å‘åº—ç™½åå•</button>
        <button class="tab-btn" onclick="switchTab('tokenQuota')">ğŸ« Tokené…é¢ç®¡ç†</button>
        <button class="tab-btn" onclick="switchTab('recommendations')">ğŸ¯ æ¨èç®¡ç†</button>
      </div>

      <!-- Charts Tab -->
      <div id="chartsTab" class="tab-content active">
        <div class="charts-grid">
          <div class="chart-container">
            <h3>ğŸ“Š æ¯æ—¥Tokenæ¶ˆè€—è¶‹åŠ¿</h3>
            <canvas id="tokenChart"></canvas>
          </div>
          <div class="chart-container">
            <h3>ğŸ“¦ æ¯æ—¥åŒæ­¥å•†å“æ•°é‡</h3>
            <canvas id="productsChart"></canvas>
          </div>
          <div class="chart-container">
            <h3>âœ… åŒæ­¥æˆåŠŸç‡</h3>
            <canvas id="successChart"></canvas>
          </div>
          <div class="chart-container">
            <h3>â±ï¸ å¹³å‡è€—æ—¶è¶‹åŠ¿</h3>
            <canvas id="durationChart"></canvas>
          </div>
        </div>
      </div>

      <!-- Logs Tab -->
      <div id="logsTab" class="tab-content">
        <div id="logsContent">
          <div class="loading">
            <div class="spinner"></div>
            <p>åŠ è½½åŒæ­¥æ—¥å¿—...</p>
          </div>
        </div>
      </div>

      <!-- Daily Stats Tab -->
      <div id="dailyTab" class="tab-content">
        <div id="dailyContent">
          <div class="loading">
            <div class="spinner"></div>
            <p>åŠ è½½æ¯æ—¥ç»Ÿè®¡...</p>
          </div>
        </div>
      </div>

      <!-- Shops Tab -->
      <div id="shopsTab" class="tab-content">
        <div id="shopsContent">
          <div class="loading">
            <div class="spinner"></div>
            <p>åŠ è½½å•†åº—åˆ—è¡¨...</p>
          </div>
        </div>
      </div>

      <!-- Whitelist Tab -->
      <div id="whitelistTab" class="tab-content">
        <div id="whitelistContent">
          <div class="loading">
            <div class="spinner"></div>
            <p>åŠ è½½ç™½åå•ç®¡ç†...</p>
          </div>
        </div>
      </div>

      <!-- Token Quota Tab -->
      <div id="tokenQuotaTab" class="tab-content">
        <div id="tokenQuotaContent">
          <div class="loading">
            <div class="spinner"></div>
            <p>åŠ è½½Tokené…é¢ç®¡ç†...</p>
          </div>
        </div>
      </div>

      <!-- Recommendations Tab -->
      <div id="recommendationsTab" class="tab-content">
        <div id="recommendationsContent">
          <div class="loading">
            <div class="spinner"></div>
            <p>åŠ è½½æ¨èæ•°æ®...</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const API_BASE = window.location.origin;
    let currentTab = 'charts';
    let statsData = null;
    let logsData = null;
    let shopsData = null;
    let recommendationsData = null;
    let currentApiKey = '';
    let charts = {};

    // åˆå§‹åŒ–
    async function init() {
      await loadShops();
      await loadData();
      // è‡ªåŠ¨åˆ·æ–°ï¼ˆæ¯30ç§’ï¼‰
      setInterval(loadData, 30000);
    }

    // åŠ è½½å•†åº—åˆ—è¡¨
    async function loadShops() {
      try {
        const response = await fetch(`${API_BASE}/api/monitoring/shops`);
        const data = await response.json();

        if (data.success) {
          shopsData = data.shops;
          const select = document.getElementById('shopFilter');
          select.innerHTML = '<option value="">æ‰€æœ‰å•†åº—</option>';
          data.shops.forEach(shop => {
            const option = document.createElement('option');
            option.value = shop.domain;
            option.textContent = `${shop.domain} (${shop.plan})`;
            select.appendChild(option);
          });
        }
      } catch (error) {
        console.error('Failed to load shops:', error);
      }
    }

    // åŠ è½½æ‰€æœ‰æ•°æ®
    async function loadData() {
      const days = document.getElementById('daysFilter').value;
      const shopDomain = document.getElementById('shopFilter').value;
      const status = document.getElementById('statusFilter').value;

      await Promise.all([
        loadStats(days, shopDomain),
        loadLogs(days, shopDomain, status),
        loadShopsList()
      ]);

      // æ¸²æŸ“å›¾è¡¨
      if (currentTab === 'charts') {
        renderCharts();
      }
    }

    // åŠ è½½ç»Ÿè®¡æ•°æ®
    async function loadStats(days, shopDomain) {
      try {
        let url = `${API_BASE}/api/monitoring/stats?days=${days}`;
        if (shopDomain) url += `&shopDomain=${shopDomain}`;

        const response = await fetch(url);
        const data = await response.json();

        if (data.success) {
          statsData = data;
          renderStats(data);
        }
      } catch (error) {
        console.error('Failed to load stats:', error);
        document.getElementById('statsGrid').innerHTML = `
          <div class="error">åŠ è½½ç»Ÿè®¡æ•°æ®å¤±è´¥: ${error.message}</div>
        `;
      }
    }

    // æ¸²æŸ“ç»Ÿè®¡å¡ç‰‡
    function renderStats(data) {
      const { summary } = data;
      const successRate = summary.totalSyncs > 0
        ? ((summary.successfulSyncs / summary.totalSyncs) * 100).toFixed(1)
        : 0;

      // Calculate token quota usage (will be updated with real data later)
      const tokenQuotaUsage = statsData?.tokenQuotaUsage || { used: 0, total: 0 };
      const tokenQuotaPercentage = tokenQuotaUsage.total > 0
        ? ((tokenQuotaUsage.used / tokenQuotaUsage.total) * 100).toFixed(1)
        : 0;

      document.getElementById('statsGrid').innerHTML = `
        <div class="stat-card">
          <h3>æ€»åŒæ­¥æ¬¡æ•°</h3>
          <div class="value">${summary.totalSyncs}</div>
          <div class="subtitle">æˆåŠŸ ${summary.successfulSyncs} / å¤±è´¥ ${summary.failedSyncs}</div>
        </div>
        <div class="stat-card success">
          <h3>æˆåŠŸç‡</h3>
          <div class="value">${successRate}%</div>
          <div class="subtitle">å¹³å‡è€—æ—¶ ${(summary.avgDuration / 1000).toFixed(2)}s</div>
        </div>
        <div class="stat-card warning">
          <h3>ç”Ÿæˆæ¨èæ•°</h3>
          <div class="value">${summary.totalRecommendations.toLocaleString()}</div>
          <div class="subtitle">AIæ™ºèƒ½æ¨è</div>
        </div>
        <div class="stat-card info">
          <h3>Tokenæ¶ˆè€—</h3>
          <div class="value">${summary.totalTokens > 0 ? summary.totalTokens.toLocaleString() : 'æš‚æ— æ•°æ®'}</div>
          <div class="subtitle">DeepSeek API</div>
        </div>
        <div class="stat-card warning">
          <h3>Tokené…é¢ä½¿ç”¨</h3>
          <div class="value">${tokenQuotaPercentage}%</div>
          <div class="subtitle">${tokenQuotaUsage.used.toLocaleString()} / ${tokenQuotaUsage.total.toLocaleString()} tokens</div>
        </div>
      `;
    }

    // åŠ è½½åŒæ­¥æ—¥å¿—
    async function loadLogs(days, shopDomain, status) {
      try {
        let url = `${API_BASE}/api/monitoring/all-sync-logs?days=${days}&limit=50`;
        if (shopDomain) url += `&shopDomain=${shopDomain}`;
        if (status) url += `&status=${status}`;

        const response = await fetch(url);
        const data = await response.json();

        if (data.success) {
          logsData = data.logs;
          renderLogs(data.logs);
        }
      } catch (error) {
        console.error('Failed to load logs:', error);
        document.getElementById('logsContent').innerHTML = `
          <div class="error">åŠ è½½æ—¥å¿—å¤±è´¥: ${error.message}</div>
        `;
      }
    }

    // æ¸²æŸ“æ—¥å¿—è¡¨æ ¼
    function renderLogs(logs) {
      if (logs.length === 0) {
        document.getElementById('logsContent').innerHTML = `
          <div class="empty">
            <div class="empty-icon">ğŸ“­</div>
            <p>æš‚æ— åŒæ­¥æ—¥å¿—</p>
          </div>
        `;
        return;
      }

      const html = `
        <div class="table-container">
          <table>
            <thead>
              <tr>
                <th>å•†åº—</th>
                <th>æ¨¡å¼</th>
                <th>çŠ¶æ€</th>
                <th>å¼€å§‹æ—¶é—´</th>
                <th>è€—æ—¶</th>
                <th>å•†å“æ•°</th>
                <th>æ¨èæ•°</th>
                <th>Token</th>
                <th>æˆæœ¬</th>
                <th>æ“ä½œ</th>
              </tr>
            </thead>
            <tbody>
              ${logs.map(log => `
                <tr>
                  <td>
                    <strong>${log.shopDomain}</strong><br>
                    <small style="color: #999;">${log.plan}</small>
                  </td>
                  <td><span class="badge badge-info">${log.mode}</span></td>
                  <td>${getStatusBadge(log.status)}</td>
                  <td>${formatDate(log.startedAt)}</td>
                  <td>${log.durationMs ? (log.durationMs / 1000).toFixed(2) + 's' : '-'}</td>
                  <td>${log.productsScanned} / ${log.productsSynced}</td>
                  <td>${log.recommendationsGenerated}</td>
                  <td>${log.tokensUsed.toLocaleString()}</td>
                  <td>$${log.estimatedCost.toFixed(4)}</td>
                  <td>
                    ${log.errorMessage ? `<button class="btn" onclick="showError('${escapeHtml(log.errorMessage)}', '${escapeHtml(log.errorStack || '')}')">æŸ¥çœ‹é”™è¯¯</button>` : '-'}
                  </td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        </div>
      `;

      document.getElementById('logsContent').innerHTML = html;
    }

    // æ¸²æŸ“æ¯æ—¥ç»Ÿè®¡
    function renderDaily() {
      if (!statsData || !statsData.daily) {
        document.getElementById('dailyContent').innerHTML = `
          <div class="loading">
            <div class="spinner"></div>
            <p>åŠ è½½æ¯æ—¥ç»Ÿè®¡...</p>
          </div>
        `;
        return;
      }

      const { daily } = statsData;

      if (daily.length === 0) {
        document.getElementById('dailyContent').innerHTML = `
          <div class="empty">
            <div class="empty-icon">ğŸ“Š</div>
            <p>æš‚æ— ç»Ÿè®¡æ•°æ®</p>
          </div>
        `;
        return;
      }

      const html = `
        <div class="table-container">
          <table>
            <thead>
              <tr>
                <th>æ—¥æœŸ</th>
                <th>åŒæ­¥æ¬¡æ•°</th>
                <th>Tokenæ¶ˆè€—</th>
                <th>æˆæœ¬</th>
                <th>å¹³å‡è€—æ—¶</th>
              </tr>
            </thead>
            <tbody>
              ${daily.map(day => `
                <tr>
                  <td><strong>${formatDate(day.date)}</strong></td>
                  <td>${day.syncCount}</td>
                  <td>${day.totalTokens.toLocaleString()}</td>
                  <td>$${day.totalCost.toFixed(4)}</td>
                  <td>${(day.avgDuration / 1000).toFixed(2)}s</td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        </div>
      `;

      document.getElementById('dailyContent').innerHTML = html;
    }

    // åŠ è½½å•†åº—åˆ—è¡¨
    async function loadShopsList() {
      if (!shopsData) return;

      renderShopsList(shopsData);
    }

    // æ¸²æŸ“å•†åº—åˆ—è¡¨
    function renderShopsList(shops) {
      if (shops.length === 0) {
        document.getElementById('shopsContent').innerHTML = `
          <div class="empty">
            <div class="empty-icon">ğŸª</div>
            <p>æš‚æ— å•†åº—</p>
          </div>
        `;
        return;
      }

      const html = `
        <div class="shop-list">
          ${shops.map(shop => `
            <div class="shop-card">
              <h4>${shop.domain}</h4>
              <div class="info">
                <span>è®¡åˆ’:</span>
                <span><strong>${shop.plan.toUpperCase()}</strong></span>
              </div>
              <div class="info">
                <span>å•†å“æ•°:</span>
                <span>${shop.productCount || 0}</span>
              </div>
              <div class="info">
                <span>é¦–æ¬¡åŒæ­¥:</span>
                <span>${shop.initialSyncDone ? 'âœ… å·²å®Œæˆ' : 'â³ æœªå®Œæˆ'}</span>
              </div>
              <div class="info">
                <span>ä¸Šæ¬¡åˆ·æ–°:</span>
                <span>${shop.lastRefreshAt ? formatDate(shop.lastRefreshAt) : '-'}</span>
              </div>
              <div class="info">
                <span>åˆ›å»ºæ—¶é—´:</span>
                <span>${formatDate(shop.createdAt)}</span>
              </div>
            </div>
          `).join('')}
        </div>
      `;

      document.getElementById('shopsContent').innerHTML = html;
    }

    // æ¸²æŸ“ç™½åå•ç®¡ç†UI
    async function renderWhitelistUI() {
      document.getElementById('whitelistContent').innerHTML = `
        <div class="loading">
          <div class="spinner"></div>
          <p>åŠ è½½ç™½åå•æ•°æ®...</p>
        </div>
      `;

      try {
        const response = await fetch(`${API_BASE}/api/admin/shops`);
        const data = await response.json();

        if (!data.success) {
          throw new Error(data.error || 'Failed to load shops');
        }

        const shops = data.shops;

        // ç»Ÿè®¡æ•°æ®
        const totalShops = shops.length;
        const devStores = shops.filter(s => s.isDevelopmentStore).length;
        const whitelisted = shops.filter(s => s.isWhitelisted).length;
        const regularStores = totalShops - devStores;

        const html = `
          <div style="margin-bottom: 20px;">
            <h2 style="color: #333; margin-bottom: 15px;">ğŸ” å¼€å‘åº—ç™½åå•ç®¡ç†</h2>
            <p style="color: #666; margin-bottom: 20px;">
              ç®¡ç†å¼€å‘å•†åº—çš„è®¿é—®æƒé™ã€‚å¼€å‘åº—é»˜è®¤ä¸èƒ½ä½¿ç”¨å…è´¹å¥—é¤ï¼Œéœ€è¦æ‰‹åŠ¨åŠ å…¥ç™½åå•æ‰èƒ½ä½¿ç”¨ã€‚
            </p>

            <div class="stats-grid" style="margin-bottom: 20px;">
              <div class="stat-card">
                <h3>æ€»å•†åº—æ•°</h3>
                <div class="value">${totalShops}</div>
                <div class="subtitle">æ‰€æœ‰æ³¨å†Œå•†åº—</div>
              </div>
              <div class="stat-card info">
                <h3>æ­£å¼å•†åº—</h3>
                <div class="value">${regularStores}</div>
                <div class="subtitle">ä»˜è´¹Shopifyè®¡åˆ’</div>
              </div>
              <div class="stat-card danger">
                <h3>å¼€å‘å•†åº—</h3>
                <div class="value">${devStores}</div>
                <div class="subtitle">éœ€è¦ç™½åå•æ‰èƒ½ä½¿ç”¨</div>
              </div>
              <div class="stat-card success">
                <h3>å·²åŠ ç™½åå•</h3>
                <div class="value">${whitelisted}</div>
                <div class="subtitle">å…è®¸è®¿é—®çš„å¼€å‘åº—</div>
              </div>
            </div>
          </div>

          <div class="table-container whitelist-table">
            <table>
              <thead>
                <tr>
                  <th>å•†åº—åŸŸå</th>
                  <th>Shopify Plan</th>
                  <th>å•†åº—ç±»å‹</th>
                  <th>ç™½åå•çŠ¶æ€</th>
                  <th>å•†å“æ•°</th>
                  <th>åˆ›å»ºæ—¶é—´</th>
                  <th>æ“ä½œ</th>
                </tr>
              </thead>
              <tbody>
                ${shops.length === 0 ? `
                  <tr>
                    <td colspan="7" style="text-align: center; padding: 40px; color: #999;">
                      æš‚æ— å•†åº—æ•°æ®
                    </td>
                  </tr>
                ` : shops.map(shop => `
                  <tr>
                    <td>
                      <strong>${shop.domain}</strong><br>
                      <small style="color: #999; font-family: monospace;">${shop.id}</small>
                    </td>
                    <td>
                      <span class="badge badge-info">${shop.planName || 'Unknown'}</span>
                    </td>
                    <td>
                      ${shop.isDevelopmentStore
                        ? '<span class="badge badge-dev">ğŸ§ª å¼€å‘å•†åº—</span>'
                        : '<span class="badge badge-regular">âœ… æ­£å¼å•†åº—</span>'
                      }
                    </td>
                    <td>
                      ${shop.isWhitelisted
                        ? '<span class="badge badge-whitelisted">âœ… å·²åŠ ç™½åå•</span>'
                        : '<span class="badge" style="background: #f0f0f0; color: #666;">âŒ æœªåŠ ç™½åå•</span>'
                      }
                    </td>
                    <td>${shop.productCount || 0}</td>
                    <td>${formatDate(shop.createdAt)}</td>
                    <td>
                      <label class="toggle-switch">
                        <input
                          type="checkbox"
                          ${shop.isWhitelisted ? 'checked' : ''}
                          onchange="toggleWhitelist('${shop.id}', '${shop.domain}', this.checked)"
                        >
                        <span class="toggle-slider"></span>
                      </label>
                    </td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          </div>
        `;

        document.getElementById('whitelistContent').innerHTML = html;
      } catch (error) {
        console.error('Failed to load whitelist data:', error);
        document.getElementById('whitelistContent').innerHTML = `
          <div class="error">
            åŠ è½½ç™½åå•æ•°æ®å¤±è´¥: ${error.message}
          </div>
        `;
      }
    }

    // åˆ‡æ¢ç™½åå•çŠ¶æ€
    async function toggleWhitelist(shopId, domain, isWhitelisted) {
      const action = isWhitelisted ? 'æ·»åŠ åˆ°' : 'ä»';
      const confirmMsg = `ç¡®å®šè¦${action}ç™½åå•å—ï¼Ÿ\n\nå•†åº—: ${domain}\n${isWhitelisted ? 'æ·»åŠ åè¯¥å¼€å‘åº—å¯ä»¥ä½¿ç”¨æœåŠ¡' : 'ç§»é™¤åè¯¥å¼€å‘åº—å°†æ— æ³•ä½¿ç”¨æœåŠ¡'}`;

      if (!confirm(confirmMsg)) {
        // ç”¨æˆ·å–æ¶ˆï¼Œæ¢å¤å¼€å…³çŠ¶æ€
        await renderWhitelistUI();
        return;
      }

      try {
        const response = await fetch(`${API_BASE}/api/admin/shops/${shopId}/whitelist`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ isWhitelisted })
        });

        if (!response.ok) {
          const error = await response.json().catch(() => ({ error: 'Unknown error' }));
          throw new Error(error.error || `HTTP ${response.status}`);
        }

        const result = await response.json();
        console.log('Whitelist updated:', result);

        // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
        alert(`æˆåŠŸ${isWhitelisted ? 'æ·»åŠ ' : 'ç§»é™¤'}ç™½åå•ï¼\n\nå•†åº—: ${domain}`);

        // é‡æ–°åŠ è½½ç™½åå•æ•°æ®
        await renderWhitelistUI();
        // åŒæ—¶åˆ·æ–°å•†åº—åˆ—è¡¨
        await loadShops();
      } catch (error) {
        console.error('Failed to toggle whitelist:', error);
        alert(`æ“ä½œå¤±è´¥: ${error.message}`);
        // æ¢å¤å¼€å…³çŠ¶æ€
        await renderWhitelistUI();
      }
    }

    // æ¸²æŸ“å›¾è¡¨
    function renderCharts() {
      if (!statsData || !statsData.daily || statsData.daily.length === 0) {
        return;
      }

      const daily = statsData.daily.slice().reverse(); // æŒ‰æ—¶é—´æ­£åºæ’åˆ—
      const labels = daily.map(d => formatDate(d.date).split(' ')[0]);

      // é”€æ¯æ—§å›¾è¡¨
      Object.values(charts).forEach(chart => {
        if (chart) chart.destroy();
      });

      // Tokenæ¶ˆè€—è¶‹åŠ¿å›¾
      const tokenCtx = document.getElementById('tokenChart').getContext('2d');
      charts.token = new Chart(tokenCtx, {
        type: 'line',
        data: {
          labels: labels,
          datasets: [{
            label: 'Tokenæ¶ˆè€—',
            data: daily.map(d => d.totalTokens),
            borderColor: '#f59e0b',
            backgroundColor: 'rgba(245, 158, 11, 0.1)',
            tension: 0.4,
            fill: true
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: true,
          plugins: {
            legend: { display: false },
            tooltip: {
              callbacks: {
                label: (context) => `Token: ${context.parsed.y.toLocaleString()}`
              }
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                callback: (value) => value.toLocaleString()
              }
            }
          }
        }
      });

      // å•†å“æ•°é‡è¶‹åŠ¿å›¾
      const productsCtx = document.getElementById('productsChart').getContext('2d');
      charts.products = new Chart(productsCtx, {
        type: 'bar',
        data: {
      abels: labels,
          datasets: [{
            label: 'åŒæ­¥æ¬¡æ•°',
            data: daily.map(d => d.syncCount),
            backgroundColor: '#3b82f6',
            borderRadius: 6
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: true,
          plugins: {
            legend: { display: false }
          },
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                stepSize: 1
              }
            }
          }
        }
      });

      // æˆåŠŸç‡å›¾è¡¨ï¼ˆåŸºäºæ—¥å¿—æ•°æ®ï¼‰
      const successData = calculateSuccessRate(daily);
      const successCtx = document.getElementById('successChart').getContext('2d');
      charts.success = new Chart(successCtx, {
        type: 'line',
        data: {
          labels: labels,
          datasets: [{
            label: 'æˆåŠŸç‡ (%)',
            data: successData,
            borderColor: '#10b981',
            backgroundColor: 'rgba(16, 185, 129, 0.1)',
            tension: 0.4,
            fill: true
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: true,
          plugins: {
            legend: { display: false },
            tooltip: {
              callbacks: {
                label: (context) => `æˆåŠŸç‡: ${context.parsed.y.toFixed(1)}%`
              }
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              max: 100,
              ticks: {
                callback: (value) => value + '%'
              }
            }
          }
        }
      });

      // è€—æ—¶è¶‹åŠ¿å›¾
      const durationCtx = document.getElementById('durationChart').getContext('2d');
      charts.duration = new Chart(durationCtx, {
        type: 'line',
        data: {
          labels: labels,
          datasets: [{
            label: 'å¹³å‡è€—æ—¶ (ç§’)',
            data: daily.map(d => (d.avgDuration / 1000).toFixed(2)),
            borderColor: '#8b5cf6',
            backgroundColor: 'rgba(139, 92, 246, 0.1)',
            tension: 0.4,
            fill: true
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: true,
          plugins: {
            legend: { display: false },
            tooltip: {
              callbacks: {
                label: (context) => `è€—æ—¶: ${context.parsed.y}ç§’`
              }
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                callback: (value) => value + 's'
              }
            }
          }
        }
      });
    }

    // è®¡ç®—æˆåŠŸç‡ï¼ˆå‡è®¾æ‰€æœ‰åŒæ­¥éƒ½æˆåŠŸï¼Œå®é™…åº”è¯¥ä»æ—¥å¿—ä¸­ç»Ÿè®¡ï¼‰
    function calculateSuccessRate(daily) {
      // ç®€åŒ–ç‰ˆæœ¬ï¼šå‡è®¾æˆåŠŸç‡ä¸º100%
      // å®é™…åº”è¯¥ä»logsDataä¸­æŒ‰æ—¥æœŸç»Ÿè®¡æˆåŠŸ/å¤±è´¥æ•°é‡
      return daily.map(d => {
        if (!logsData) return 100;

        const dayLogs = logsData.filter(log => {
          const logDate = new Date(log.startedAt).toISOString().split('T')[0];
          const targetDate = new Date(d.date).toISOString().split('T')[0];
          return logDate === targetDate;
        });

        if (dayLogs.length === 0) return 100;

        const successCount = dayLogs.filter(log => log.status === 'success').length;
        return (successCount / dayLogs.length * 100).toFixed(1);
      });
    }

    // åˆ‡æ¢æ ‡ç­¾
    function switchTab(tab) {
      currentTab = tab;

      // æ›´æ–°æŒ‰é’®çŠ¶æ€
      document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
      event.target.classList.add('active');

      // æ›´æ–°å†…å®¹æ˜¾ç¤º
      document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
      document.getElementById(`${tab}Tab`).classList.add('active');

      // æ¸²æŸ“å¯¹åº”å†…å®¹
      if (tab === 'charts') {
        renderCharts();
      } else if (tab === 'daily') {
        renderDaily();
      } else if (tab === 'shops') {
        loadShopsList();
      } else if (tab === 'whitelist') {
        renderWhitelistUI();
      } else if (tab === 'tokenQuota') {
        renderTokenQuotaUI();
      } else if (tab === 'recommendations') {
        renderRecommendationsUI();
      }
    }

    // æ¸²æŸ“Tokené…é¢ç®¡ç†UI
    async function renderTokenQuotaUI() {
      document.getElementById('tokenQuotaContent').innerHTML = `
        <div class="loading">
          <div class="spinner"></div>
          <p>åŠ è½½Tokené…é¢æ•°æ®...</p>
        </div>
      `;

      try {
        // å¹¶è¡Œè·å–shopsæ•°æ®å’Œå…¨å±€é…é¢æ•°æ®
        const [shopsResponse, quotaResponse] = await Promise.all([
          fetch(`${API_BASE}/api/admin/shops`),
          fetch(`${API_BASE}/api/admin/global-quota`)
        ]);

        const shopsData = await shopsResponse.json();
        const quotaData = await quotaResponse.json();

        if (!shopsData.success) {
          throw new Error(shopsData.error || 'Failed to load shops');
        }

        const shops = shopsData.shops;

        // ç»Ÿè®¡æ•°æ® - åªè®¡ç®—FREEç”¨æˆ·
        const totalShops = shops.length;
        const freeShops = shops.filter(s => (s.plan || 'free') === 'free');
        const freeShopCount = freeShops.length;
        const totalFreeUsed = freeShops.reduce((sum, s) => sum + (s.tokensUsedToday || 0), 0);

        // å…¨å±€é…é¢ - ä»APIè·å–
        const globalQuota = quotaData.dailyTokenQuota || 140000000;
        const totalRemaining = Math.max(0, globalQuota - totalFreeUsed);
        const usagePercentage = globalQuota > 0 ? Math.min(100, (totalFreeUsed / globalQuota * 100).toFixed(1)) : 0;

        const html = `
          <div style="margin-bottom: 20px;">
            <h2 style="color: #333; margin-bottom: 15px;">ğŸ« Tokené…é¢ç®¡ç†</h2>
            <p style="color: #666; margin-bottom: 20px;">
              ç®¡ç†æ¯ä¸ªå•†åº—çš„æ¯æ—¥Tokené…é¢ï¼Œé˜²æ­¢æœåŠ¡å™¨èµ„æºè¢«æ»¥ç”¨ã€‚å…è´¹ç”¨æˆ·é»˜è®¤æ¯å¤©10,000,000 tokens (1000ä¸‡)ã€‚
            </p>

            <!-- å…¨å±€é…é¢è®¾ç½® -->
            <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 30px; border-radius: 12px; margin-bottom: 20px; color: white; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);">
              <h3 style="margin: 0 0 20px 0; font-size: 20px;">ğŸŒ å…¨å±€FREEç”¨æˆ·é…é¢</h3>
              <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 20px;">
                <div>
                  <div style="font-size: 14px; opacity: 0.9; margin-bottom: 5px;">æ¯æ—¥æ€»é…é¢</div>
                  <div style="font-size: 32px; font-weight: 700;">${globalQuota.toLocaleString()}</div>
                  <div style="font-size: 12px; opacity: 0.8;">tokens/å¤©</div>
                </div>
                <div>
                  <div style="font-size: 14px; opacity: 0.9; margin-bottom: 5px;">ä»Šæ—¥å·²ä½¿ç”¨</div>
                  <div style="font-size: 32px; font-weight: 700;">${totalFreeUsed.toLocaleString()}</div>
                  <div style="font-size: 12px; opacity: 0.8;">${freeShopCount} ä¸ªå…è´¹å•†åº—</div>
                </div>
                <div>
                  <div style="font-size: 14px; opacity: 0.9; margin-bottom: 5px;">å‰©ä½™é…é¢</div>
                  <div style="font-size: 32px; font-weight: 700;">${totalRemaining.toLocaleString()}</div>
                  <div style="font-size: 12px; opacity: 0.8;">${usagePercentage}% å·²ä½¿ç”¨</div>
                </div>
              </div>

              <div style="background: rgba(255, 255, 255, 0.2); height: 12px; border-radius: 6px; overflow: hidden; margin-bottom: 20px;">
                <div style="height: 100%; width: ${usagePercentage}%; background: ${usagePercentage > 80 ? '#ef4444' : usagePercentage > 50 ? '#f59e0b' : '#10b981'}; transition: width 0.3s;"></div>
              </div>

              <div style="display: flex; gap: 10px; align-items: center;">
                <input
                  type="number"
                  id="globalQuotaInput"
                  value="${globalQuota}"
                  min="0"
                  step="10000000"
                  style="flex: 1; padding: 12px 15px; border: 2px solid rgba(255,255,255,0.3); border-radius: 8px; font-size: 16px; background: rgba(255,255,255,0.9); color: #333; font-weight: 600;"
                  placeholder="è®¾ç½®å…¨å±€é…é¢"
                />
                <button
                  onclick="updateGlobalQuota()"
                  style="padding: 12px 24px; background: white; color: #667eea; border: none; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; white-space: nowrap;"
                >
                  ğŸ’¾ æ›´æ–°å…¨å±€é…é¢
                </button>
                <button
                  onclick="resetAllFreeTokens()"
                  style="padding: 12px 24px; background: rgba(255,255,255,0.2); color: white; border: 2px solid white; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; white-space: nowrap;"
                >
                  ğŸ”„ é‡ç½®æ‰€æœ‰FREEç”¨æˆ·
                </button>
              </div>
            </div>

            <div class="stats-grid" style="margin-bottom: 20px;">
              <div class="stat-card">
                <h3>æ€»å•†åº—æ•°</h3>
                <div class="value">${totalShops}</div>
                <div class="subtitle">æ‰€æœ‰æ³¨å†Œå•†åº—</div>
              </div>
              <div class="stat-card info">
                <h3>å…è´¹å•†åº—</h3>
                <div class="value">${freeShopCount}</div>
                <div class="subtitle">å—é…é¢é™åˆ¶</div>
              </div>
              <div class="stat-card warning">
                <h3>ä»˜è´¹å•†åº—</h3>
                <div class="value">${totalShops - freeShopCount}</div>
                <div class="subtitle">ä¸å—é…é¢é™åˆ¶</div>
              </div>
              <div class="stat-card ${totalFreeUsed > globalQuota * 0.8 ? 'danger' : 'success'}">
                <h3>é…é¢åˆ©ç”¨ç‡</h3>
                <div class="value">${usagePercentage}%</div>
                <div class="subtitle">${totalRemaining.toLocaleString()} tokens å‰©ä½™</div>
              </div>
            </div>
          </div>

          <div class="table-container">
            <table>
              <thead>
                <tr>
                  <th>å•†åº—åŸŸå</th>
                  <th>è®¡åˆ’</th>
                  <th>ä»Šæ—¥å·²ç”¨</th>
                  <th>ä½¿ç”¨å æ¯”</th>
                  <th>é…é¢é‡ç½®</th>
                  <th>åŒæ­¥æƒé™</th>
                  <th>æ“ä½œ</th>
                </tr>
              </thead>
              <tbody>
                ${shops.length === 0 ? `
                  <tr>
                    <td colspan="7" style="text-align: center; padding: 40px; color: #999;">
                      æš‚æ— å•†åº—æ•°æ®
                    </td>
                  </tr>
                ` : shops.map(shop => {
                  const used = shop.tokensUsedToday || 0;
                  const plan = (shop.plan || 'free').toUpperCase();
                  const isFree = plan === 'FREE';
                  const percentage = isFree && globalQuota > 0 ? ((used / globalQuota) * 100).toFixed(3) : 0;
                  const resetDate = shop.quotaResetDate ? new Date(shop.quotaResetDate).toLocaleDateString('zh-CN') : 'æœªè®¾ç½®';
                  const isSyncEnabled = shop.isSyncEnabled !== false; // é»˜è®¤ä¸ºtrue

                  return `
                    <tr style="${!isSyncEnabled ? 'opacity: 0.6; background: #fff3cd;' : ''}">
                      <td>
                        <strong>${shop.domain}</strong><br>
                        <small style="color: #999; font-family: monospace;">${shop.id}</small>
                      </td>
                      <td>
                        <span class="badge badge-${plan === 'FREE' ? 'info' : 'success'}">${plan}</span>
                      </td>
                      <td style="font-weight: bold; color: ${isFree && used > globalQuota * 0.5 ? '#dc3545' : '#333'};">
                        ${used.toLocaleString()}
                        ${!isFree ? '<br><small style="color: #999;">ä¸å—é™åˆ¶</small>' : ''}
                      </td>
                      <td>
                        ${isFree ? `
                          <div style="display: flex; align-items: center; gap: 8px;">
                            <div style="flex: 1; height: 8px; background: #e9ecef; border-radius: 4px; overflow: hidden;">
                              <div style="height: 100%; width: ${Math.min(100, percentage)}%; background: ${percentage > 50 ? '#dc3545' : percentage > 20 ? '#ffc107' : '#28a745'}; transition: width 0.3s;"></div>
                            </div>
                            <span style="font-size: 12px; font-weight: bold; min-width: 60px;">${percentage}%</span>
                          </div>
                        ` : '<span style="color: #999;">-</span>'}
                      </td>
                      <td style="font-size: 12px; color: #666;">${resetDate}</td>
                      <td>
                        <span
                          class="badge ${!isSyncEnabled ? 'badge-danger' : 'badge-success'}"
                          style="cursor: pointer; user-select: none;"
                          onclick="toggleSyncPermission('${shop.id}', '${shop.domain}', ${!isSyncEnabled})"
                          title="ç‚¹å‡»åˆ‡æ¢åŒæ­¥æƒé™"
                        >
                          ${!isSyncEnabled ? 'ğŸš« å·²ç¦ç”¨' : 'âœ… å·²å¯ç”¨'}
                        </span>
                      </td>
                      <td>
                        <div style="display: flex; gap: 5px; flex-wrap: wrap;">
                          ${isFree ? `
                            <button
                              onclick="resetTokenUsage('${shop.id}', '${shop.domain}')"
                              style="padding: 4px 8px; font-size: 11px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer;"
                              title="é‡ç½®ä»Šæ—¥ä½¿ç”¨é‡"
                            >
                              ğŸ”„ é‡ç½®
                            </button>
                          ` : ''}
                          <button
                            onclick="toggleSyncPermission('${shop.id}', '${shop.domain}', ${!isSyncEnabled})"
                            style="padding: 4px 8px; font-size: 11px; background: ${isSyncEnabled ? '#dc3545' : '#007bff'}; color: white; border: none; border-radius: 4px; cursor: pointer;"
                            title="${isSyncEnabled ? 'ç¦ç”¨åŒæ­¥' : 'å¯ç”¨åŒæ­¥'}"
                          >
                            ${isSyncEnabled ? 'ğŸš« ç¦ç”¨' : 'âœ… å¯ç”¨'}
                          </button>
                        </div>
                      </td>
                    </tr>
                  `;
                }).join('')}
              </tbody>
            </table>
          </div>

          <div style="margin-top: 20px; padding: 15px; background: #e8f5e9; border-radius: 8px; border: 1px solid #a5d6a7;">
            <h4 style="margin: 0 0 10px 0; color: #2e7d32;">ğŸ’¡ ä½¿ç”¨è¯´æ˜</h4>
            <ul style="margin: 0; padding-left: 20px; color: #2e7d32; line-height: 1.8;">
              <li><strong>å…¨å±€é…é¢:</strong> æ‰€æœ‰FREEç”¨æˆ·å…±äº«ä¸€ä¸ªæ¯æ—¥Tokenæ€»é…é¢ï¼ˆé»˜è®¤140,000,000 tokensï¼‰</li>
              <li><strong>é…é¢é‡ç½®:</strong> æ¯å¤©é¦–æ¬¡åŒæ­¥æ—¶è‡ªåŠ¨é‡ç½®</li>
              <li><strong>ä»˜è´¹ç”¨æˆ·:</strong> ä¸å—é…é¢é™åˆ¶ï¼Œå¯ä»¥æ— é™ä½¿ç”¨</li>
              <li><strong>åŒæ­¥æƒé™:</strong> å¯ä»¥å•ç‹¬ç¦ç”¨æŸä¸ªå•†åº—çš„åŒæ­¥åŠŸèƒ½ï¼Œè¯¥å•†åº—å°†æ— æ³•è¿›è¡Œä»»ä½•åŒæ­¥æ“ä½œ</li>
              <li><strong>ä½¿ç”¨å æ¯”:</strong> æ˜¾ç¤ºæ¯ä¸ªFREEå•†åº—å å…¨å±€é…é¢çš„ç™¾åˆ†æ¯”</li>
            </ul>
          </div>
        `;

        document.getElementById('tokenQuotaContent').innerHTML = html;
      } catch (error) {
        console.error('Failed to load token quota data:', error);
        document.getElementById('tokenQuotaContent').innerHTML = `
          <div class="error">
            åŠ è½½Tokené…é¢æ•°æ®å¤±è´¥: ${error.message}
          </div>
        `;
      }
    }

    // æ›´æ–°å…¨å±€é…é¢
    async function updateGlobalQuota() {
      const input = document.getElementById('globalQuotaInput');
      const newQuota = parseInt(input.value);

      if (isNaN(newQuota) || newQuota < 0) {
        alert('è¯·è¾“å…¥æœ‰æ•ˆçš„é…é¢æ•°é‡ï¼ˆâ‰¥0ï¼‰');
        return;
      }

      if (!confirm(`ç¡®å®šè¦æ›´æ–°å…¨å±€é…é¢å—ï¼Ÿ\n\næ–°é…é¢: ${newQuota.toLocaleString()} tokens/å¤©\n\nè¿™å°†å½±å“æ‰€æœ‰FREEç”¨æˆ·çš„é…é¢ã€‚`)) {
        return;
      }

      try {
        const response = await fetch(`${API_BASE}/api/admin/global-quota`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ dailyTokenQuota: newQuota })
        });

        if (!response.ok) {
          const error = await response.json().catch(() => ({ error: 'Unknown error' }));
          throw new Error(error.error || `HTTP ${response.status}`);
        }

        const result = await response.json();
        console.log('Global quota updated:', result);

        alert(`æˆåŠŸæ›´æ–°å…¨å±€é…é¢ï¼\n\næ–°é…é¢: ${newQuota.toLocaleString()} tokens/å¤©`);

        // é‡æ–°åŠ è½½Tokené…é¢æ•°æ®
        await renderTokenQuotaUI();
      } catch (error) {
        console.error('Failed to update global quota:', error);
        alert(`æ›´æ–°å¤±è´¥: ${error.message}`);
      }
    }

    // é‡ç½®æ‰€æœ‰FREEç”¨æˆ·çš„Tokenä½¿ç”¨é‡
    async function resetAllFreeTokens() {
      if (!confirm('ç¡®å®šè¦é‡ç½®æ‰€æœ‰FREEç”¨æˆ·çš„ä»Šæ—¥Tokenä½¿ç”¨é‡å—ï¼Ÿ\n\nè¿™å°†é‡ç½®æ‰€æœ‰å…è´¹å•†åº—çš„Tokenä½¿ç”¨ç»Ÿè®¡ã€‚')) {
        return;
      }

      try {
        const response = await fetch(`${API_BASE}/api/admin/reset-all-free-tokens`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          }
        });

        if (!response.ok) {
          const error = await response.json().catch(() => ({ error: 'Unknown error' }));
          throw new Error(error.error || `HTTP ${response.status}`);
        }

        const result = await response.json();
        console.log('All free tokens reset:', result);

        alert(`æˆåŠŸé‡ç½®æ‰€æœ‰FREEç”¨æˆ·çš„Tokenä½¿ç”¨é‡ï¼\n\né‡ç½®äº† ${result.resetCount} ä¸ªå•†åº—`);

        // é‡æ–°åŠ è½½Tokené…é¢æ•°æ®
        await renderTokenQuotaUI();
      } catch (error) {
        console.error('Failed to reset all free tokens:', error);
        alert(`é‡ç½®å¤±è´¥: ${error.message}`);
      }
    }

    // åˆ‡æ¢å•†åº—çš„åŒæ­¥æƒé™
    async function toggleSyncPermission(shopId, domain, enable) {
      const action = enable ? 'å¯ç”¨' : 'ç¦ç”¨';
      if (!confirm(`ç¡®å®šè¦${action}è¯¥å•†åº—çš„åŒæ­¥æƒé™å—ï¼Ÿ\n\nå•†åº—: ${domain}\n\n${enable ? 'å¯ç”¨åè¯¥å•†åº—å¯ä»¥è¿›è¡ŒåŒæ­¥æ“ä½œ' : 'ç¦ç”¨åè¯¥å•†åº—å°†æ— æ³•è¿›è¡Œä»»ä½•åŒæ­¥æ“ä½œ'}`)) {
        return;
      }

      try {
        const response = await fetch(`${API_BASE}/api/admin/shops/${shopId}/sync-permission`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ isSyncEnabled: enable })
        });

        if (!response.ok) {
          const error = await response.json().catch(() => ({ error: 'Unknown error' }));
          throw new Error(error.error || `HTTP ${response.status}`);
        }

        const result = await response.json();
        console.log('Sync permission updated:', result);

        alert(`æˆåŠŸ${action}åŒæ­¥æƒé™ï¼\n\nå•†åº—: ${domain}`);

        // é‡æ–°åŠ è½½Tokené…é¢æ•°æ®
        await renderTokenQuotaUI();
        // åŒæ—¶åˆ·æ–°å•†åº—åˆ—è¡¨
        await loadShops();
      } catch (error) {
        console.error('Failed to toggle sync permission:', error);
        alert(`æ“ä½œå¤±è´¥: ${error.message}`);
      }
    }

    // é‡ç½®Tokenä½¿ç”¨é‡
    async function resetTokenUsage(shopId, domain) {
      if (!confirm(`ç¡®å®šè¦é‡ç½®ä»Šæ—¥Tokenä½¿ç”¨é‡å—ï¼Ÿ\\n\\nå•†åº—: ${domain}\\n\\né‡ç½®åè¯¥å•†åº—ä»Šæ—¥çš„Tokenä½¿ç”¨é‡å°†å½’é›¶ã€‚`)) {
        return;
      }

      try {
        const response = await fetch(`${API_BASE}/api/admin/shops/${shopId}/reset-tokens`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          }
        });

        if (!response.ok) {
          const error = await response.json().catch(() => ({ error: 'Unknown error' }));
          throw new Error(error.error || `HTTP ${response.status}`);
        }

        const result = await response.json();
        console.log('Token usage reset:', result);

        alert(`æˆåŠŸé‡ç½®Tokenä½¿ç”¨é‡ï¼\\n\\nå•†åº—: ${domain}`);

        // é‡æ–°åŠ è½½Tokené…é¢æ•°æ®
        await renderTokenQuotaUI();
      } catch (error) {
        console.error('Failed to reset token usage:', error);
        alert(`é‡ç½®å¤±è´¥: ${error.message}`);
      }
    }

    // æ¸²æŸ“æ¨èç®¡ç†UI
    function renderRecommendationsUI() {
      // ç”Ÿæˆå•†åº—é€‰é¡¹
      const shopOptions = shopsData && shopsData.length > 0
        ? shopsData.map(shop => `<option value="${shop.apiKey || ''}">${shop.domain} (${shop.plan})</option>`).join('')
        : '<option value="">æš‚æ— å•†åº—æ•°æ®</option>';

      document.getElementById('recommendationsContent').innerHTML = `
        <div class="api-key-input">
          <select
            id="apiKeyInput"
            style="flex: 1; padding: 10px 15px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px; font-family: 'Courier New', monospace;"
            onchange="currentApiKey = this.value"
          >
            <option value="">è¯·é€‰æ‹©å•†åº—</option>
            ${shopOptions}
          </select>
          <button class="btn btn-primary" onclick="loadRecommendations()">ğŸ” æŸ¥è¯¢æ¨è</button>
        </div>
        <div id="recommendationsData">
          <div class="empty">
            <div class="empty-icon">ğŸ¯</div>
            <p>è¯·é€‰æ‹©å•†åº—æŸ¥è¯¢æ¨èæ•°æ®</p>
          </div>
        </div>
      `;

      // å¦‚æœæœ‰å½“å‰API Keyï¼Œè®¾ç½®é€‰ä¸­çŠ¶æ€
      if (currentApiKey) {
        const select = document.getElementById('apiKeyInput');
        if (select) {
          select.value = currentApiKey;
        }
      }
    }

    // åŠ è½½æ¨èæ•°æ®
    async function loadRecommendations() {
      const apiKey = document.getElementById('apiKeyInput').value.trim();

      if (!apiKey) {
        alert('è¯·è¾“å…¥API Key');
        return;
      }

      currentApiKey = apiKey;

      document.getElementById('recommendationsData').innerHTML = `
        <div class="loading">
          <div class="spinner"></div>
          <p>åŠ è½½æ¨èæ•°æ®...</p>
        </div>
      `;

      try {
        const response = await fetch(`${API_BASE}/api/recommendations?limit=9999`, {
          headers: {
            'X-API-Key': apiKey
          }
        });

        if (!response.ok) {
          const error = await response.json().catch(() => ({ error: 'Unknown error' }));
          throw new Error(error.error || `HTTP ${response.status}`);
        }

        const data = await response.json();
        recommendationsData = data;
        renderRecommendations(data);
      } catch (error) {
        console.error('Failed to load recommendations:', error);
        document.getElementById('recommendationsData').innerHTML = `
          <div class="error">
            åŠ è½½æ¨èæ•°æ®å¤±è´¥: ${error.message}
            <br><br>
            <small>è¯·æ£€æŸ¥API Keyæ˜¯å¦æ­£ç¡®</small>
          </div>
        `;
      }
    }

    // æ¸²æŸ“æ¨èæ•°æ®
    function renderRecommendations(data) {
      if (!data.recommendations || data.recommendations.length === 0) {
        document.getElementById('recommendationsData').innerHTML = `
          <div class="recommendations-header">
            <div class="info">
              <div class="info-item">
                <label>å•†åº—</label>
                <div class="value">${data.shop}</div>
              </div>
              <div class="info-item">
                <label>å•†å“æ•°</label>
                <div class="value">${data.stats.products}</div>
              </div>
              <div class="info-item">
                <label>æ¨èæ•°</label>
                <div class="value">0</div>
              </div>
            </div>
            <button class="btn btn-danger" disabled style="opacity: 0.5;">
              ğŸ—‘ï¸ æ¸…ç©ºæ¨èå’Œå•†å“
            </button>
          </div>
          <div class="empty">
            <div class="empty-icon">ğŸ“­</div>
            <p>æš‚æ— æ¨èæ•°æ®</p>
            <small style="color: #999;">å½“å‰å•†åº—è¿˜æ²¡æœ‰ç”Ÿæˆä»»ä½•æ¨è</small>
          </div>
        `;
        return;
      }

      // æŒ‰æºå•†å“åˆ†ç»„
      const grouped = {};
      data.recommendations.forEach(rec => {
        const key = rec.sourceProductId;
        if (!grouped[key]) {
          grouped[key] = {
            source: {
              id: rec.sourceProductId,
              title: rec.sourceTitle,
              image: rec.sourceImage
            },
            recommendations: []
          };
        }
        grouped[key].recommendations.push({
          id: rec.targetProductId,
          title: rec.targetTitle,
          image: rec.targetImage,
          reason: rec.reason,
          createdAt: rec.createdAt
        });
      });

      const html = `
        <div class="recommendations-header">
          <div class="info">
            <div class="info-item">
              <label>å•†åº—</label>
              <div class="value" style="font-size: 18px;">${data.shop}</div>
            </div>
            <div class="info-item">
              <label>å•†å“æ•°</label>
              <div class="value">${data.stats.products}</div>
            </div>
            <div class="info-item">
              <label>æ¨èæ•°</label>
              <div class="value">${data.stats.recommendations}</div>
            </div>
            <div class="info-item">
              <label>æœ‰æ¨èçš„å•†å“</label>
              <div class="value">${Object.keys(grouped).length}</div>
            </div>
          </div>
          <button class="btn btn-danger" onclick="clearRecommendations()">
            ğŸ—‘ï¸ æ¸…ç©ºæ‰€æœ‰æ¨è
          </button>
        </div>
        <div>
          ${Object.values(grouped).map(group => `
            <div class="recommendation-card">
              <div class="recommendation-card-header">
                ${group.source.image ? `<img src="${group.source.image}" class="product-image" alt="${group.source.title}">` : '<div class="product-image" style="background: #f0f0f0; display: flex; align-items: center; justify-content: center; color: #999;">æ— å›¾ç‰‡</div>'}
                <div class="product-info">
                  <h4>${group.source.title}</h4>
                  <div class="product-id">${group.source.id}</div>
                  <div style="margin-top: 5px;">
                    <span class="badge badge-info">${group.recommendations.length} ä¸ªæ¨è</span>
                  </div>
                </div>
              </div>
              <div class="recommendations-list">
                ${group.recommendations.map(rec => `
                  <div class="recommendation-item">
                    ${rec.image ? `<img src="${rec.image}" alt="${rec.title}">` : '<div style="width: 100%; height: 120px; background: #f0f0f0; border-radius: 6px; display: flex; align-items: center; justify-content: center; color: #999; margin-bottom: 10px;">æ— å›¾ç‰‡</div>'}
                    <h5>${rec.title}</h5>
                    <div class="product-id">${rec.id}</div>
                    ${rec.reason ? `<div class="reason">${rec.reason}</div>` : ''}
                  </div>
                `).join('')}
              </div>
            </div>
          `).join('')}
        </div>
      `;

      document.getElementById('recommendationsData').innerHTML = html;
    }

    // æ¸…ç©ºæ¨è
    async function clearRecommendations() {
      if (!currentApiKey) {
        alert('è¯·å…ˆè¾“å…¥API Key');
        return;
      }

      if (!confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰æ¨èå’Œå•†å“å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼\n\nå°†ä¼šåˆ é™¤ï¼š\nâ€¢ æ‰€æœ‰AIæ¨èæ•°æ®\nâ€¢ æ‰€æœ‰å•†å“æ•°æ®')) {
        return;
      }

      try {
        const response = await fetch(`${API_BASE}/api/recommendations`, {
          method: 'DELETE',
          headers: {
            'X-API-Key': currentApiKey
          }
        });

        if (!response.ok) {
          const error = await response.json().catch(() => ({ error: 'Unknown error' }));
          throw new Error(error.error || `HTTP ${response.status}`);
        }

        const result = await response.json();
        alert(`æˆåŠŸåˆ é™¤ï¼š\nâ€¢ ${result.deletedRecommendations} æ¡æ¨è\nâ€¢ ${result.deletedProducts} ä¸ªå•†å“`);

        // é‡æ–°åŠ è½½æ¨èæ•°æ®
        await loadRecommendations();
      } catch (error) {
        console.error('Failed to clear recommendations:', error);
        alert(`æ¸…ç©ºå¤±è´¥: ${error.message}`);
      }
    }

    // æ˜¾ç¤ºé”™è¯¯è¯¦æƒ…
    function showError(message, stack) {
      alert(`é”™è¯¯ä¿¡æ¯:\n${message}\n\nå †æ ˆ:\n${stack}`);
    }

    // å·¥å…·å‡½æ•°
    function getStatusBadge(status) {
      const badges = {
        success: '<span class="badge badge-success">æˆåŠŸ</span>',
        failed: '<span class="badge badge-danger">å¤±è´¥</span>',
        started: '<span class="badge badge-warning">è¿›è¡Œä¸­</span>'
      };
      return badges[status] || status;
    }

    function formatDate(dateStr) {
      const date = new Date(dateStr);
      return date.toLocaleString('zh-CN', {
        year: 'numeric',
        month: '2-digit',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit'
      });
    }

    function escapeHtml(text) {
      if (!text) return '';
      return text.replace(/'/g, "\\'").replace(/"/g, '\\"').replace(/\n/g, '\\n');
    }

    // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
    window.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
